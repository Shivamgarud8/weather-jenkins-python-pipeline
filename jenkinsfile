pipeline {
    agent any

    environment {
        EC2_IP = '16.16.99.185'            // Your EC2 public IP
        SSH_CRED = 'node-cred'                // Jenkins credential ID for EC2 SSH key
        APP_DIR = '/home/ubuntu/weather-app'
    }

    stages {
        stage('Clone Repository') {
            steps {
                echo "ğŸ“¦ Cloning repository..."
                git branch: 'main', url: 'https://github.com/Shivamgarud8/weather-jenkins-python-pipeline.git'
            }
        }

        stage('Deploy to EC2') {
            steps {
                echo "ğŸš€ Deploying Flask Weather App to EC2..."
                sshagent([SSH_CRED]) {
                    sh '''
                        # Create app directory on EC2
                        ssh -o StrictHostKeyChecking=no ubuntu@${EC2_IP} "mkdir -p ${APP_DIR}"

                        # Copy files to EC2
                        scp -o StrictHostKeyChecking=no -r app.py requirements.txt templates ubuntu@${EC2_IP}:${APP_DIR}/

                        # Install dependencies and start app
                        ssh -o StrictHostKeyChecking=no ubuntu@${EC2_IP} "
                            cd ${APP_DIR} &&
                            sudo apt update -y &&
                            sudo apt install -y python3-pip python3-venv &&
                            python3 -m venv venv &&
                            source venv/bin/activate &&
                            pip install --upgrade pip &&
                            pip install -r requirements.txt &&
                            # Stop old process if running
                            sudo fuser -k 5000/tcp || true &&
                            # Run app with Gunicorn
                            nohup venv/bin/gunicorn -b 0.0.0.0:5000 app:app > app.log 2>&1 &
                        "
                    '''
                }
            }
        }

        stage('Health Check') {
            steps {
                echo "ğŸ” Checking if Flask app is accessible..."
                script {
                    sleep 5 // wait for app to start
                    def status = sh(script: "curl -s -o /dev/null -w '%{http_code}' http://${EC2_IP}:5000", returnStdout: true).trim()
                    if (status == '200') {
                        echo "âœ… App is running successfully at: http://${EC2_IP}:5000"
                    } else {
                        error("âŒ Health check failed. App not responding on port 5000.")
                    }
                }
            }
        }
    }

    post {
        success {
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Access the app here â†’ http://${EC2_IP}:5000"
        }
        failure {
            echo "âŒ Deployment Failed! Please check Jenkins and app logs."
        }
    }
}
